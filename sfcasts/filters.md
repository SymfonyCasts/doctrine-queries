# Filters: Automatically Modify Queries

Coming soon!

Until then, here is the legacy version: https://symfonycasts.com/screencast/doctrine-queries-legacy/filters

So we now know how we could call use our cool new method here to filter out the discontinued fortune cookies. But what if we want to apply some criteria globally to all queries for some table? Like, what if we could automatically tell Doctrine that whenever we query for the fortune cookies, we want to add a where is discontinued false to that query? This is totally possible. So to show it off, I'm going to reverse our two templates here, back to the way they were before. And if I go into Proverbs here, yep, we can see the three, all three show up again. So the way you do this is by creating something called a filter. So in the source directory, I don't have to do this, but for organization, I'll create a Doctrine directory and a new class called a discontinued filter. This needs to extend SQL filter. And then I'll go to co-generate or command N on a Mac to go to implement methods. This requires us to have one add filter constraint. So this is pretty cool. What's going to happen is that Doctrine is going to automatically call add filter constraint when it's building a query. It's going to pass us some information about which entity we're querying for. This class metadata knows all about our entity, whether it's a fortune cookie or a category. It's also going to pass us the target table alias, which you'll see us use that in a second for the query. Now you may see a deprecation notice. Add a string return type to, otherwise you might see a deprecation notice about adding that. Alright, see what's happening in here. Let's just do our favorite thing. We're going to dd target entity and target table alias. Now if you refresh the page now, nothing happens. That is not called automatically. We need to activate it. So that's a two-step process. First thing is in config packages, doctrine.yaml, we're going to inside of here tell Doctrine that this exists. So you need to be anywhere under that ORM key. So I'm going to add filters and then fortune cookie underscore discontinued. You'll see where that key is used in a second. You could write anything there. And then set that to our class, app slash doctrine slash discontinued filter. Easy peasy.  So this is now registered with Doctrine, but as you can see over here, it's still not called. So the last step is that you're going to activate it because you might not want this discontinued filter to be used everywhere on your site. So check this out. In our controller, there we go. Let's go up here to the homepage and I'm going to auto wire in entity manager interface, entity manager. And then right on top, we'll say entity manager arrow filter, get filters, and then you can say enable. And here we're going to use that same key that we use in YAML. I'll actually go grab it. Fortune cookie discontinued, fortune cookie discontinued. Now everything after this in our code is going to apply that. It's going to call, every query we make after this is going to use our filter. So now, still doesn't work. Oh, head to the homepage and yes, it hit it. So you can see this class metadata. It's a big class that knows all about our entity. And down here you can see that apparently for whatever query we're making first, the table alias is C0 underscore. So now we can get to work. So once we enable this, it's going to be called whenever we query for any entity in the system. So the first thing we want to do is say, if target entity arrow get reflection class, arrow name, arrow name does not equal fortune cookie colon colon class. That means we're querying for something else and we're going to return empty quotes. So this method is supposed to return a string. And whatever string we return here is going to kind of turn into a where clause. So we're just returning empty quotes in that case. Down here, we'll return sprintf percent s dot discontinued equals false. And then we'll pass in the target table alias for that. All right, check this out. So on the homepage, proverbs count should go from three to two. It does. And if you check out the query for it, you can see there's a little T dot discontinued false stuck up inside all of the queries. That is awesome. Now, one tricky thing about these filters is that they are not services. So you can't have a constructor. It's not allowed.  So if you need to like pass something into this, you have to do it a different way. So for example, let's pretend that when we use this filter, sometimes we want to hide discontinued, and sometimes we only want to show discontinued. So we basically want to be able to control this value here from false to true. So the way to do that is to change this to percent s, and then fill it in with this arrow get parameter, and then I'm just going to make up a key here called discontinued. You're going to see how that's used in a second. This is one thing I don't normally do, percent s's inside of my queries, because that can allow SQL injection attacks. In this case it's okay, because this value, you'll see we're going to supply this ourselves. So we need to make sure that this value here does not ever come from the user. It needs to be something that we are controlling. All right, so if we try it now, we're going to get a giant error that says parameter discontinued does not exist. So I just made up this word discontinued here. As soon as you have a parameter, you need to pass that in when you enable the filter. So you can do that with set parameter, discontinued. Let's say false, so we're actually going to... False. False. And now, got it. And let's just try that to change that to true, and you'll see, yep, the numbers change again. Awesome. So the last question you're probably wondering is, this is cool, but can I enable a filter globally, like automatically, without needing to put it on my controller like this? The answer is absolutely. So I'm going to comment this out, and we'll see here that our number is going to go back to three. And to enable it globally, you can just do this right inside the configuration. So we're just going to actually make this config a little more complicated, so I'll knock it onto the next line, set that to class, set enabled to true, and just like that, this is going to be enabled everywhere. Now if we try this, we'd get an error because we're missing the parameter, so that's where we need to also say parameters, discontinued, false. There you go. Filter is pretty sweet.  Next, let's talk quickly about how to use the handy in operator with a query.
